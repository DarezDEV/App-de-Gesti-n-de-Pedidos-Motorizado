{% extends 'base.html' %}

{% block title %}Detalles del Pedido{% endblock %}

{% block content %}
<main class="flex flex-col py-6">
  <nav class="flex justify-start w-full px-4 sm:px-12 mb-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{{ url_for('motorizado_pedidos') }}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-amber-500">
                Pedidos
            </a>
        </li>
        <li aria-current="page">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Detalles del Pedido #{{ order['order_id'] }}</span>
            </div>
        </li>
    </ol>
  </nav>
  <div class="container mx-auto px-4 sm:px-6 py-2">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="bg-[#F49A13] p-4 flex justify-between items-center">
        <h1 class="text-white text-xl font-bold">Pedido #{{ order['order_id'] }}</h1>
        <span id="status-badge" class="bg-white text-[#F49A13] px-3 py-1 rounded-full font-semibold">{{ order['status']|capitalize }}</span>
      </div>

      <div class="p-6">
        <div class="mb-6">
          <h2 class="text-lg font-semibold mb-3 border-b pb-2">Información del Pedido</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-gray-600 mb-1">Fecha del pedido:</p>
              <p class="font-medium">{{ order['created_at'] }}</p>
            </div>
            <div>
              <p class="text-gray-600 mb-1">Cliente:</p>
              <p class="font-medium">{{ order['client_name'] }}</p>
            </div>
            <div>
              <p class="text-gray-600 mb-1">Dirección de Entrega:</p>
              <p class="font-medium">{{ order['address'] }}</p>
            </div>
            <div>
              <p class="text-gray-600 mb-1">Estado:</p>
              <p id="status-text" class="font-medium">{{ order['status']|capitalize }}</p>
            </div>
            {% if order['status'] == 'en camino' %}
            <div>
              <p class="text-gray-600 mb-1">Confirmación:</p>
              <div class="flex items-center gap-2">
                <span class="flex items-center {% if order.get('motorizado_confirm_delivery') %}text-green-500{% else %}text-gray-400{% endif %}">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span id="confirmacion-motorizado">Motorizado: {% if order.get('motorizado_confirm_delivery') %}Confirmado{% else %}Pendiente{% endif %}</span>
                </span>
                <span class="mx-2">|</span>
                <span class="flex items-center {% if order.get('client_confirm_delivery') %}text-green-500{% else %}text-gray-400{% endif %}">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span id="confirmacion-cliente">Cliente: {% if order.get('client_confirm_delivery') %}Confirmado{% else %}Pendiente{% endif %}</span>
                </span>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="mb-6">
          <h2 class="text-lg font-semibold mb-3 border-b pb-2">Productos del Pedido</h2>
          {% if order['items'] %}
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-4 py-2 text-left text-gray-600">Producto</th>
                  <th class="px-4 py-2 text-center text-gray-600">Cantidad</th>
                  <th class="px-4 py-2 text-right text-gray-600">Precio Unit.</th>
                  <th class="px-4 py-2 text-right text-gray-600">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order['items'] %}
                <tr class="border-b">
                  <td class="px-4 py-3">
                    <div class="flex items-center">
                      <div class="w-10 h-10 bg-gray-200 rounded mr-3">
                        <img src="{{ url_for('static', filename='uploads/' ~ item['image']) }}" alt="{{ item['name'] }}" class="w-full h-full object-cover">
                      </div>
                      <span>{{ item['name'] }}</span>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-center">{{ item['quantity'] }}</td>
                  <td class="px-4 py-3 text-right">RD${{ "%.2f"|format(item['price']) }}</td>
                  <td class="px-4 py-3 text-right font-medium">RD${{ "%.2f"|format(item['price'] * item['quantity']) }}</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="px-4 py-3 text-right font-semibold">Total:</td>
                  <td class="px-4 py-3 text-right font-semibold">RD${{ "%.2f"|format(order['total_amount']) }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
          {% else %}
          <p>No hay productos en este pedido.</p>
          {% endif %}
        </div>

        <div class="mt-8 border-t pt-5">
          <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex gap-3 order-2 sm:order-1">
              <a href="{{ url_for('motorizado_pedidos') }}" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Volver a Mis Pedidos
              </a>
            </div>

            {% if order['status'] == 'en camino' %}
            <div id="action-buttons" class="flex gap-3 order-1 sm:order-2 w-full sm:w-auto">
              <a href="{{ url_for('motorizado_map', order_id=order['order_id']) }}" class="py-2 px-4 border border-[#F49A13] rounded-lg text-[#F49A13] hover:bg-amber-50 transition flex items-center justify-center flex-1 sm:flex-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                Ver en mapa
              </a>
              {% if not order.get('motorizado_confirm_delivery') %}
              <button id="btn-confirmar" class="bg-[#F49A13] text-white py-2 px-4 rounded-lg hover:bg-amber-600 transition flex items-center justify-center flex-1 sm:flex-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Confirmar Entrega
              </button>
              {% else %}
              <button disabled class="bg-gray-300 text-gray-600 py-2 px-4 rounded-lg flex items-center justify-center flex-1 sm:flex-auto cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Entrega Confirmada
              </button>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Definir la función marcarEntregado en el ámbito global
  function marcarEntregado(orderId) {
    Swal.fire({
      title: '¿Confirmar entrega?',
      text: '¿Confirmas que has entregado este pedido?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#F49A13',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, confirmar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        const btnConfirmar = document.getElementById('btn-confirmar');
        if (btnConfirmar) {
          btnConfirmar.disabled = true;
          btnConfirmar.innerHTML = `
            <svg class="animate-spin h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Procesando...
          `;
        }

        fetch(`/marcar_entregado/${orderId}`, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const motorizadoConfirm = document.getElementById('confirmacion-motorizado');
            if (motorizadoConfirm) {
              motorizadoConfirm.innerHTML = 'Motorizado: Confirmado';
              motorizadoConfirm.parentElement.classList.remove('text-gray-400');
              motorizadoConfirm.parentElement.classList.add('text-green-500');
            }

            const btnConfirmar = document.getElementById('btn-confirmar');
            if (btnConfirmar) {
              btnConfirmar.outerHTML = `
                <button disabled class="bg-gray-300 text-gray-600 py-2 px-4 rounded-lg flex items-center justify-center flex-1 sm:flex-auto cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Entrega Confirmada
                </button>
              `;
            }

            if (data.fully_delivered) {
              const statusBadge = document.getElementById('status-badge');
              const statusText = document.getElementById('status-text');
              if (statusBadge) statusBadge.textContent = 'Entregado';
              if (statusText) statusText.textContent = 'Entregado';

              const actionButtons = document.getElementById('action-buttons');
              if (actionButtons) actionButtons.style.display = 'none';
            }

            showNotification('Éxito', data.message, 'success');
          } else {
            showNotification('Error', data.message || 'No se pudo marcar como entregado.', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('Error', 'Error de conexión al servidor. Por favor, intenta de nuevo.', 'error');
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    const ORDER_ID = {{ order['order_id'] }};
    const MOTORIZADO_ID = {{ session.get('user_id', 0) }};

    function showNotification(title, message, type) {
      Swal.fire({
        title: title,
        text: message,
        icon: type,
        confirmButtonColor: '#F49A13',
        confirmButtonText: 'Aceptar'
      });
    }

    function closeFlash() {
      const notification = document.getElementById('flash');
      if (notification) {
        notification.classList.add('slide-out');
        notification.addEventListener('transitionend', () => {
          notification.remove();
        });
      }
    }

    // Asignar el evento click al botón
    const btnConfirmar = document.getElementById('btn-confirmar');
    if (btnConfirmar) {
      btnConfirmar.addEventListener('click', function() {
        marcarEntregado(ORDER_ID);
      });
    }

    if (typeof io !== 'undefined') {
      const socket = io('/motorizado');

      socket.on('connect', function() {
        console.log('Conectado a socket.io');
      });

      socket.on('delivery_confirmed_by_client', (data) => {
        if (data.order_id == ORDER_ID) {
          showNotification('Cliente ha confirmado', `${data.cliente_name} marcó como entregado, solo faltas tú.`, 'info');
          const clienteConfirm = document.getElementById('confirmacion-cliente');
          if (clienteConfirm) {
            clienteConfirm.innerHTML = 'Cliente: Confirmado';
            clienteConfirm.parentElement.classList.remove('text-gray-400');
            clienteConfirm.parentElement.classList.add('text-green-500');
          }
        }
      });

      socket.on('order_delivered', (data) => {
        if (data.order_id == ORDER_ID) {
          const statusBadge = document.getElementById('status-badge');
          const statusText = document.getElementById('status-text');
          if (statusBadge) statusBadge.textContent = 'Entregado';
          if (statusText) statusText.textContent = 'Entregado';

          const actionButtons = document.getElementById('action-buttons');
          if (actionButtons) actionButtons.style.display = 'none';

          showNotification('Éxito', 'El pedido ha sido marcado como entregado por ambas partes.', 'success');
        }
      });

      socket.on('order_status_update', function(data) {
        if (data.order_id == ORDER_ID) {
          console.log('Actualización recibida:', data);

          if (data.client_confirmed) {
            const clienteConfirm = document.getElementById('confirmacion-cliente');
            if (clienteConfirm) {
              clienteConfirm.innerHTML = 'Cliente: Confirmado';
              clienteConfirm.parentElement.classList.remove('text-gray-400');
              clienteConfirm.parentElement.classList.add('text-green-500');
            }
          }

          if (data.status === 'entregado') {
            const statusBadge = document.getElementById('status-badge');
            const statusText = document.getElementById('status-text');
            if (statusBadge) statusBadge.textContent = 'Entregado';
            if (statusText) statusText.textContent = 'Entregado';

            const actionButtons = document.getElementById('action-buttons');
            if (actionButtons) actionButtons.style.display = 'none';

            showNotification('Éxito', 'Pedido completado y marcado como entregado', 'success');
          }
        }
      });
    }
  });
</script>
{% endblock %}